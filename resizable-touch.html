<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>resizable sortable</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%}
  body{min-height:100%}
  .flexible-area{
    height:100%;
    border:1px solid #ccc;
    display:grid;
    grid-template-columns: 1fr 8px 1fr;
    gap:0;
    overflow:hidden; 
  }
  .col{
    display:flex;
    flex-direction:column;
    align-items:stretch;
    overflow:visible;
  }
  .grip{
    background:#e5e7eb;
    cursor:col-resize;
    user-select:none;
  }
  .card{
    position:relative;
    min-height:120px;
    height:50%;
    flex:none;
    display:flex; flex-direction:column;
    overflow:hidden;
    border-bottom:1px solid #f0f0f0;
  }
  .card:last-child{border-bottom:none}
  .content{
    overflow-y:auto;
    padding:12px;
		height:100%;
  }
  .resize-v{
    position:absolute; left:0; right:0; bottom:0;
    height:6px; background:#ddd; cursor:row-resize; z-index:2;
  }
  .flexible-area .card:last-child .resize-v{display:none;}
  .no-select{ user-select:none; }
  .toolbar{position:fixed; right:12px; bottom:12px;}
  .toolbar button{padding:6px 10px; border:1px solid #ddd; background:#fff; cursor:pointer; border-radius:6px;}
	.sortable-item{border:1px solid #555;}
	.sortable-item .sortable-header{background:#CCC; cursor:move; touch-action:none;}
	.sortable-item + .sortable-item{margin-top:10px;}
	.grip{touch-action:none; -webkit-touch-callout:none; -webkit-user-select:none;}
	.resize-v{touch-action:none; -webkit-touch-callout:none;}

	/* Mobile responsive */
	@media (max-width: 768px) {
		.grip{
			height:40px;
			cursor:row-resize;
			background:#f00;
			position:relative;
			display:flex;
			align-items:center;
			justify-content:center;
		}
		.grip::before{
			content:"⋮⋮⋮";
			color:#fff;
			font-size:20px;
			letter-spacing:4px;
		}
		.col{min-height:200px;}
		.resize-v{height:20px; background:#ddd;}
		.sortable-item .sortable-header{padding:12px; font-size:16px;}
	}
</style>
</head>
<body>

<div class="flexible-area" id="flexArea">
  <div class="col" id="colL"><!-- 왼쪽 -->
    <div class="card" style="background:#fafafa;">
      <div class="content column">
				*** contents1 ***
				<div class="sortable-item">
					<div class="sortable-header">sortable 1</div>
					<div class="sortable-content">sortable contents</div>
				</div>
				<div class="sortable-item">
					<div class="sortable-header">sortable 2</div>
					<div class="sortable-content">sortable contents</div>
				</div>
			</div>
      <div class="resize-v"></div>
    </div>
    <div class="card" style="background:#fff7ed;">
      <div class="content column">
				*** contents2 ***
        <div class="sortable-item">
					<div class="sortable-header">sortable 3</div>
					<div class="sortable-content">sortable contents sortable contentssortable contentssortable contentssortable contentssortable contents</div>
				</div>
      </div>
      <div class="resize-v"></div>
    </div>
  </div>
  <div class="grip" id="grip" aria-label="resize columns"></div><!-- col 조절 -->
  <div class="col" id="colR"><!-- 오른쪽 -->
    <div class="card" style="background:#f0f9ff;">
      <div class="content column">
				*** contents3 ***
			</div>
      <div class="resize-v"></div>
    </div>
    <div class="card" style="background:#f6fff6;">
      <div class="content  column">*** contents4 ***</div>
      <div class="resize-v"></div>
    </div>
  </div>
</div>

<div class="toolbar">
  <button id="resetBtn">레이아웃 초기화</button>
</div>
<script src="js/jquery-3.7.1.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/jquery.ui.touch-punch.min.js"></script>
<script>
(() => {
  // Global variables
  const box = document.getElementById('flexArea');
  const grip = document.getElementById('grip');
  const colL = document.getElementById('colL');
  const colR = document.getElementById('colR');
  const KEY = 'persistedLayout:v1';
  const gripW = () => grip.getBoundingClientRect().width || 8;

  // Touch event utilities
  function getEventPos(e) {
    return {
      clientX: e.touches ? e.touches[0].clientX : e.clientX,
      clientY: e.touches ? e.touches[0].clientY : e.clientY
    };
  }

  function isMobile() {
    return window.innerWidth <= 768;
  }

  // Initialize sortable functionality
  function initSortable() {
    $(".column").sortable({
      connectWith: ".column",
      handle: ".sortable-header",
      helper: "clone",
      opacity: 0.8,
      appendTo: "body",
      tolerance: "pointer",
      scroll: true,
      scrollSensitivity: 40,
      scrollSpeed: 40,
      start: function(event, ui) {
        // 모바일에서 드래그 시작 시 스타일 조정
        if(isMobile()) {
          ui.helper.css({
            'pointer-events': 'none',
            'transform': 'scale(1.05)',
            'z-index': '99999'
          });
        }
      },
      stop: function(event, ui) {
        // 드래그 종료 시 스타일 복구
        if(isMobile()) {
          ui.item.css({
            'transform': '',
            'z-index': ''
          });
        }
      }
    });

    // 모바일 터치 지원을 위한 추가 이벤트 핸들링
    if(isMobile()) {
      enableMobileSortable();
    }
  }

  // 모바일 sortable 터치 지원
  function enableMobileSortable() {
    let isDragging = false;
    let dragElement = null;
    let placeholder = null;
    let startPos = null;

    $(".sortable-header").on("touchstart", function(e) {
      const touch = e.originalEvent.touches[0];
      const $item = $(this).closest(".sortable-item");

      isDragging = false;
      dragElement = $item[0];
      startPos = { x: touch.clientX, y: touch.clientY };

      e.preventDefault();
    });

    $(document).on("touchmove", function(e) {
      if (!dragElement) return;

      const touch = e.originalEvent.touches[0];
      const deltaX = Math.abs(touch.clientX - startPos.x);
      const deltaY = Math.abs(touch.clientY - startPos.y);

      if (!isDragging && (deltaX > 10 || deltaY > 10)) {
        isDragging = true;
        startMobileDrag(dragElement, touch);
      }

      if (isDragging) {
        updateMobileDrag(touch);
        e.preventDefault();
      }
    });

    $(document).on("touchend", function(e) {
      if (isDragging) {
        endMobileDrag();
      }
      dragElement = null;
      isDragging = false;
      startPos = null;
    });

    function startMobileDrag(element, touch) {
      const $element = $(element);

      // Create placeholder
      placeholder = $('<div class="sortable-placeholder">').css({
        height: $element.outerHeight(),
        margin: $element.css('margin'),
        border: '2px dashed #ccc',
        background: '#f9f9f9'
      });

      $element.after(placeholder);

      // Style dragging element
      $element.css({
        position: 'fixed',
        zIndex: 99999,
        opacity: 0.8,
        transform: 'scale(1.05)',
        pointerEvents: 'none',
        left: touch.clientX - $element.outerWidth() / 2,
        top: touch.clientY - $element.outerHeight() / 2
      });
    }

    function updateMobileDrag(touch) {
      if (!dragElement) return;

      const $element = $(dragElement);

      // Update position
      $element.css({
        left: touch.clientX - $element.outerWidth() / 2,
        top: touch.clientY - $element.outerHeight() / 2
      });

      // Find drop target
      const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
      const $column = $(elementBelow).closest('.column');

      if ($column.length > 0) {
        const $items = $column.find('.sortable-item').not(dragElement);
        let insertAfter = null;

        $items.each(function() {
          const rect = this.getBoundingClientRect();
          if (touch.clientY < rect.top + rect.height / 2) {
            return false; // break
          }
          insertAfter = this;
        });

        if (insertAfter) {
          $(insertAfter).after(placeholder);
        } else {
          $column.prepend(placeholder);
        }
      }
    }

    function endMobileDrag() {
      if (!dragElement || !placeholder) return;

      const $element = $(dragElement);

      // Reset styles
      $element.css({
        position: '',
        zIndex: '',
        opacity: '',
        transform: '',
        pointerEvents: '',
        left: '',
        top: ''
      });

      // Move element to placeholder position
      placeholder.replaceWith($element);
      placeholder = null;
    }
  }

  // Initialize resizable functionality
  function initResizable() {
    initColumnResize();
    initVerticalResize();
  }

  // Initialize column resize (horizontal)
  function initColumnResize() {
    let gripActive = false, startX = 0, startY = 0, leftW = 0, rightW = 0;

    function onGripDown(e){
      e.preventDefault();
      console.log('Grip down:', e.type, 'isMobile:', isMobile());
      gripActive = true;
      const pos = getEventPos(e);

      // Always use horizontal resize (no layout change)
      startX = pos.clientX;
      leftW = colL.getBoundingClientRect().width;
      rightW = colR.getBoundingClientRect().width;

      console.log('Grip start values:', {startX, leftW, rightW});

      document.body.classList.add('no-select');

      if (isMobile()) {
        // 모바일에서는 터치 이벤트만 사용
        window.addEventListener('touchmove', onGripMove, {passive: false});
        window.addEventListener('touchend', onGripUp);
      } else {
        // 데스크톱에서는 pointer/mouse 이벤트 사용
        window.addEventListener('pointermove', onGripMove);
        window.addEventListener('pointerup', onGripUp);
        window.addEventListener('mousemove', onGripMove);
        window.addEventListener('mouseup', onGripUp);
      }
    }

    function onGripMove(e){
      if(!gripActive) return;
      e.preventDefault();
      const pos = getEventPos(e);

      // Always use horizontal resize (no layout change)
      const dx = pos.clientX - startX;
      const minCol = 180;
      const total = box.getBoundingClientRect().width;
      const gW = gripW();
      let newLeft = Math.max(minCol, Math.min(leftW + dx, total - gW - minCol));
      let newRight = total - gW - newLeft;

      console.log('Grip move:', {dx, newLeft, newRight, total});
      box.style.setProperty('grid-template-columns', `${newLeft}px ${gW}px ${newRight}px`, 'important');
    }

    function onGripUp(){
      console.log('Grip up');
      gripActive = false;
      document.body.classList.remove('no-select');

      if (isMobile()) {
        window.removeEventListener('touchmove', onGripMove);
        window.removeEventListener('touchend', onGripUp);
      } else {
        window.removeEventListener('pointermove', onGripMove);
        window.removeEventListener('pointerup', onGripUp);
        window.removeEventListener('mousemove', onGripMove);
        window.removeEventListener('mouseup', onGripUp);
      }
      saveLayout();
    }

    // Add both pointer and touch events
    if (isMobile()) {
      // 모바일에서는 터치 이벤트만 사용
      grip.addEventListener('touchstart', onGripDown, {passive: false});

      // 추가 모바일 전용 터치 핸들러
      grip.addEventListener('touchstart', function(e) {
        console.log('Direct mobile touch on grip');
        grip.style.background = '#00f'; // 파란색으로 변경
        setTimeout(() => grip.style.background = '', 100);
      }, {passive: false});

      console.log('Mobile grip touch events added');
    } else {
      // 데스크톱에서는 pointer 이벤트 사용
      grip.addEventListener('pointerdown', onGripDown);
      grip.addEventListener('mousedown', onGripDown); // fallback
    }

    // 강제로 모든 이벤트 추가 (디버깅용)
    grip.addEventListener('click', (e) => {
      console.log('Grip clicked!', e.type);
    });

    grip.addEventListener('touchstart', (e) => {
      console.log('Raw touchstart on grip');
    }, {passive: true});
  }

  // Initialize vertical resize
  function initVerticalResize() {
    let activeTop = null, startY = 0, startTopH = 0, colH = 0;

    function onVDown(e){
      e.preventDefault();
      const topCard = e.currentTarget.closest('.card');
      const col = topCard.parentElement;
      const botCard = topCard.nextElementSibling;
      if(!botCard || !botCard.classList.contains('card')) return;

      activeTop = { topCard, botCard, col };
      const pos = getEventPos(e);
      startY = pos.clientY;
      startTopH = topCard.offsetHeight;
      colH = col.clientHeight;

      document.body.classList.add('no-select');
      window.addEventListener('pointermove', onVMove);
      window.addEventListener('pointerup', onVUp);
      window.addEventListener('touchmove', onVMove, {passive: false});
      window.addEventListener('touchend', onVUp);
    }

    function onVMove(e){
      if(!activeTop) return;
      e.preventDefault();
      const pos = getEventPos(e);
      const dy = pos.clientY - startY;
      const minH = isMobile() ? 80 : 120;
      const maxTop = colH - minH;
      const newTop = Math.max(minH, Math.min(startTopH + dy, maxTop));
      const newBot = colH - newTop;

      activeTop.topCard.style.height = newTop + 'px';
      activeTop.botCard.style.height = newBot + 'px';
      activeTop.topCard.style.flex = 'none';
      activeTop.botCard.style.flex = 'none';
    }

    function onVUp(){
      saveLayout();
      activeTop = null;
      document.body.classList.remove('no-select');
      window.removeEventListener('pointermove', onVMove);
      window.removeEventListener('pointerup', onVUp);
      window.removeEventListener('touchmove', onVMove);
      window.removeEventListener('touchend', onVUp);
    }

    document.querySelectorAll('.col .card:not(:last-child) .resize-v')
      .forEach(h => {
        h.addEventListener('pointerdown', onVDown);
        h.addEventListener('touchstart', onVDown, {passive: false});
      });
  }

  function saveLayout(){
    const total = box.getBoundingClientRect().width;
    const leftW = colL.getBoundingClientRect().width;
    const rightW = colR.getBoundingClientRect().width;
    const leftRatio = leftW / (leftW + rightW);

    const Lcards = colL.querySelectorAll('.card');
    const Rcards = colR.querySelectorAll('.card');

    const Lsum = (Lcards[0]?.offsetHeight || 0) + (Lcards[1]?.offsetHeight || 0);
    const Rsum = (Rcards[0]?.offsetHeight || 0) + (Rcards[1]?.offsetHeight || 0);
    const LtopRatio = Lsum ? (Lcards[0]?.offsetHeight / Lsum) : 0.5;
    const RtopRatio = Rsum ? (Rcards[0]?.offsetHeight / Rsum) : 0.5;

    const data = { leftRatio, LtopRatio, RtopRatio };
    localStorage.setItem(KEY, JSON.stringify(data));
  }

  function restoreLayout(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    let data;
    try { data = JSON.parse(raw); } catch { return; }

    // 열 폭 복원
    const total = box.getBoundingClientRect().width;
    const gW = gripW();
    const usable = total - gW;
    const leftPx = Math.max(180, Math.min(usable - 180, Math.round(usable * (data.leftRatio ?? 0.5))));
    const rightPx = usable - leftPx;
    box.style.gridTemplateColumns = `${leftPx}px ${gW}px ${rightPx}px`;

    applyColumnHeights(colL, data.LtopRatio ?? 0.5);
    applyColumnHeights(colR, data.RtopRatio ?? 0.5);
  }

  function applyColumnHeights(col, topRatio){
    const cards = col.querySelectorAll('.card');
    if(cards.length < 2) return;
    const H = col.clientHeight;
    const minH = 120;

    let topH = Math.max(minH, Math.min(H - minH, Math.round(H * topRatio)));
    let botH = H - topH;

    if(botH < minH){ botH = minH; topH = H - botH; }

    cards[0].style.height = topH + 'px';
    cards[1].style.height = botH + 'px';
    cards[0].style.flex = 'none';
    cards[1].style.flex = 'none';
  }

  function reapplyOnResize(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    let data;
    try { data = JSON.parse(raw); } catch { return; }
    // 열
    const total = box.getBoundingClientRect().width;
    const gW = gripW();
    const usable = total - gW;
    const leftPx = Math.max(180, Math.min(usable - 180, Math.round(usable * (data.leftRatio ?? 0.5))));
    const rightPx = usable - leftPx;
    box.style.gridTemplateColumns = `${leftPx}px ${gW}px ${rightPx}px`;
    // 카드
    applyColumnHeights(colL, data.LtopRatio ?? 0.5);
    applyColumnHeights(colR, data.RtopRatio ?? 0.5);
  }

  // Initialize all functionality
  function init() {
    initSortable();
    initResizable();
  }

  window.addEventListener('load', () => {
    restoreLayout();
    init();
  });

  let t;
  window.addEventListener('resize', () => {
    clearTimeout(t);
    t = setTimeout(reapplyOnResize, 50);
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    localStorage.removeItem(KEY);
    // 기본값으로 리셋
    box.style.gridTemplateColumns = '1fr 8px 1fr';
    colL.querySelectorAll('.card').forEach(c => { c.style.height='50%'; c.style.flex='none'; });
    colR.querySelectorAll('.card').forEach(c => { c.style.height='50%'; c.style.flex='none'; });
  });
})();
</script>
</body>
</html>
